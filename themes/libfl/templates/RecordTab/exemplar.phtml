<?php
    // Set page title.
    $this->headTitle($this->translate('Access') . ': ' . $this->driver->getBreadcrumb());

    $formatter = $this->recordDataFormatter();
    $getExemplars = $formatter->getData($driver, $formatter->getDefaults('libfl_exemplar'));
    
    if (isset($getExemplars['Exemplar']['value']) && !empty($getExemplars['Exemplar']['value'])) {
        $getExemplarsData = json_decode(htmlspecialchars_decode($getExemplars['Exemplar']['value']));
    }
    
    $fields = $getExemplarsData[0];
    $exemplars = json_decode($getExemplarsData[1][0]);
    $getAccessMethod = (string) $this->driver->getMethodOfAccess()[0];
    $accessMethod = (!empty($getAccessMethod)) ? strtolower($getAccessMethod) : '';
    if (!empty($exemplars)) {
        foreach ($exemplars as $num=>$exemplar):
            echo '<h3 style="font-weight:bold;">Экземпляр ' . $num .'</h3>';
            echo '<table class="table table-striped" summary="'.$this->transEsc('Exemplars').'" style="margin-bottom:40px;">';
            foreach ($fields as $field) {
                if (!empty($exemplar->$field)) {
                    if ($field == 'exemplar_hyperlink')
                        $exemplar->$field = "<a href='".$exemplar->$field."' target='_blank'>".$exemplar->$field."</a>";
                    if ($field == 'exemplar_inv_note') {
                        echo "<tr><th>".$this->transEsc('exemplar_inventory_number').": </th><td>".$exemplar->exemplar_inventory_number." (".$this->transEsc('exemplar_inv_note').": ".$exemplar->exemplar_inv_note.")</td></tr>";
                    }
                    echo "<tr><th>".$this->transEsc($field).": </th><td>".$exemplar->$field."</td></tr>";
                }
            }
            $accessStatus = ($exemplar->exemplar_id) ? $this->driver->getAccessStatus($exemplar->exemplar_id, $this->driver->getUniqueId()) : 'Не доступен';
            echo (empty($accessMethod))
                ? "<tr><td colspan='2' style='background-color: #fff!important; border-style: solid!important; border-width: 1px 0px 1px 0px!important; border-color: #b9b9b9!important; color:#ff0000; font-weight:bold;'>Статус: ".$this->transEsc('status_'.$accessStatus)."</td></tr>"
                : "<tr><td colspan='2' style='background-color: #fff!important; border-style: solid!important; border-width: 1px 0px 1px 0px!important; border-color: #b9b9b9!important; color:#0000f3; font-weight:bold;'>Статус: ".$this->transEsc('status_'.$accessStatus)." (".$accessMethod.") </td></tr>";
            echo '</table>';
        endforeach;
    } else {
        echo "<tr><td>" . $this->transEsc('no_exemplars') . "</td></tr>";
    }
?>
